# Nginx configuration for WAF pipeline
# This file should be included in /etc/nginx/nginx.conf or placed in /etc/nginx/conf.d/

# Detailed log format for WAF analysis
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   '"$http_x_forwarded_for" "$http_cookie" '
                   '"$content_type" "$content_length" '
                   '"$request_body"';

# Access log with detailed format
access_log /var/log/nginx/access.log detailed;
error_log /var/log/nginx/error.log;

# Upstream servers for the three applications
upstream app1 {
    server localhost:8080;
}

upstream app2 {
    server localhost:8081;
}

upstream app3 {
    server localhost:8082;
}

# Server block for app1
server {
    listen 80;
    server_name app1.local;

    location / {
        proxy_pass http://app1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Log request body for POST requests
        proxy_set_header Content-Length $content_length;
        proxy_set_header Content-Type $content_type;
    }
}

# Server block for app2
server {
    listen 80;
    server_name app2.local;

    location / {
        proxy_pass http://app2;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Server block for app3
server {
    listen 80;
    server_name app3.local;

    location / {
        proxy_pass http://app3;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Default server - route to app1
server {
    listen 80 default_server;
    server_name _;

    location / {
        proxy_pass http://app1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
